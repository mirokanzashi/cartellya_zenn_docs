---
title: "OAuth"
emoji: "✅"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["学習記録"]
published: true
---

# OAuth

OAuthは、第三者アプリに対して利用者の権限を安全に委譲するための認可プロトコルであり、認証は行わいません。

:::message
現在のOauthは基本的にOAuth2.0を指します。OAuth 1.0はほぼ廃止の状態になります。
:::

:::message
利用者識別が必要な場合は OpenID Connectを使います
:::

## 仕組み
- 典型的な利用例はソーシャルログインです

| 役割                   | 説明           |
| -------------------- | ------------ |
| Resource Owner       | 利用者、ユーザー      |
| Client               | 権限を使いたいアプリ   |
| Authorization Server | 認可を行いトークンを発行 |
| Resource Server      | APIやデータを提供   |

> 下のシーケンス図は、Authorization ServerとResource Serverを同一サーバーになります

```mermaid
sequenceDiagram
    autonumber
    participant B as ブラウザ<br/>(ユーザー)
    participant Client as サービス(Client)<br/>[例: 写真プリントアプリ]
    participant Auth as 認可サーバ<br/>[例: Google / LINE]

    Note over B, Client: 【1. 連携開始】
    B->>Client: 「Googleで連携」をクリック
    Client-->>B: 認可サーバへリダイレクト指示<br/>(Client ID / スコープ等)

    Note over B, Auth: 【2. ユーザー同意】
    B->>Auth: 認可リクエストを送信
    Note right of Auth: ログイン確認 & 同意画面表示
    B->>Auth: 「許可する」ボタンを押下
    
    Note over Auth, B: 【3. 認可コードの発行】
    Auth-->>B: Clientへ戻れ！と指示<br/>(認可コードを付与)
    Note left of B: ブラウザが「認可コード」を運ぶ

    Note over B, Client: 【4. 認可コードの提出】
    B->>Client: 認可コードを渡す
    
    Note over Client, Auth: 【5. トークン交換 (ここだけ直接通信)】
    Client->>Auth: 認可コード + Client Secret を送信
    Note right of Auth: 正しければアクセストークンを発行
    Auth-->>Client: アクセストークンを返却

    Note over Client, B: 【6. 完了】
    Client-->>B: 連携完了画面を表示

```

## PKCE（Proof Key for Code Exchange）
- OAuth 2.0 の Authorization Code Flow において、認可コード横取り攻撃を防止するための拡張仕様です。
- 認可コードを取得したクライアント本人でなければ、トークン交換できないようにします

### 背景
従来の Authorization Code Flow は、クライアントシークレットを安全に保持できるサーバサイドアプリを前提としていました。
しかし、モバイルアプリやSPA（Single Page Application）のような公開クライアントでは
- クライアントシークレットを安全に保持できない
- 認可コードが盗まれると不正にトークン交換される
という問題がありました

:::message
**認可コード横取攻撃**：盗まれる認可コードを使ってアクセストークンを入手するという攻撃です
:::

### PKCEなしの処理(認可コード横取攻撃)
```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー (Browser/OS)
    participant Client as 正当なアプリ
    participant Attacker as 悪意のあるアプリ
    participant AuthServer as 認可サーバー

    Note over Client, Attacker: 同じカスタムURLスキームを登録済み

    User->>Client: アプリで「ログイン」をタップ
    Client->>User: ブラウザを開き認可URLへリダイレクト
    User->>AuthServer: 認可リクエスト (PKCEなし)
    
    AuthServer->>User: ログイン画面・同意画面の表示
    User->>AuthServer: 認証情報入力・同意
    
    AuthServer-->>User: 認可コードを付与してリダイレクト<br/>(com.example.app://callback?code=XYZ)

    Note over User, Attacker: OSがカスタムURLスキームを検知
    User->>Attacker: OSが悪意のあるアプリを起動し<br/>認可コードを渡してしまう

    Note over Attacker: 認可コード(XYZ)を奪取
    
    Attacker->>AuthServer: トークンリクエスト (code=XYZ)
    AuthServer->>Attacker: アクセストークン発行
    
    Note right of Attacker: 攻撃成功：ユーザーデータにアクセス
```

**説明**
- 事前準備: モバイルOSなどの環境で、攻撃アプリが正当なアプリと同じ「カスタムURLスキーム（例: myapp://）」を登録しておきます。
- 認可コードの露出 (ステップ6-7): 認可サーバーが発行した認可コードは、ブラウザからOSを経由してアプリに届けられます。この際、OSがどちらのアプリに渡すか判断を誤る（または攻撃アプリが優先される）ことで横取りが発生します。
- トークンの取得 (ステップ8-9): PKCEが導入されていない場合、認可コードさえあればトークンへの交換が可能であるため、攻撃者は正当なアプリになりすましてトークンを取得できてしまいます。

### PKCEありの処理
```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー (Browser/OS)
    participant Client as 正当なアプリ
    participant Attacker as 悪意のあるアプリ
    participant AuthServer as 認可サーバー

    Note over Client: 1. 一時的な合言葉(Verifier)を作成<br/>2. ハッシュ化(Challenge)を作成

    Client->>User: 認可URLへリダイレクト
    User->>AuthServer: 認可リクエスト + [Challenge]
    
    AuthServer->>AuthServer: Challengeを一時保存
    
    User->>AuthServer: 認証・同意
    
    AuthServer-->>User: 認可コードを付与してリダイレクト
    User->>Attacker: OSの不備により認可コードを横取り

    Note over Attacker: 認可コードは手に入れたが<br/>「元の合言葉(Verifier)」を知らない

    Attacker->>AuthServer: トークンリクエスト (コードのみ)
    AuthServer-->>Attacker: 401 Unauthorized<br/>(Verifierが不足または不一致)

    Note over Client: --- 正当なアプリの場合 ---
    Client->>AuthServer: トークンリクエスト (コード + [Verifier])
    AuthServer->>AuthServer: Verifierをハッシュ化して<br/>保存済みのChallengeと照合
    AuthServer->>Client: アクセストークン発行
```

**説明**
- 合言葉の送付: 最初の認可リクエスト（ステップ3）では、生の値（verifier）ではなく、ハッシュ化した値（challenge）のみを認可サーバーに送ります。
- 攻撃者の限界: 攻撃者が認可コードを横取りできても、正当なアプリのメモリ内にある「生の合言葉（verifier）」は盗めません。
- サーバーでの検証: 認可サーバーは、トークン交換時に送られてきた verifier を再度ハッシュ化し、最初に受け取った challenge と一致するか確認します。攻撃者は verifier を知らないため、この検証を突破できません。

## stateパラメータ
- OAuth 2.0／OpenID Connect において、CSRF（Cross-Site Request Forgery）攻撃を防止するために用いられる仕組みです。
- stateは、認可要求と認可応答が「同一セッションに属する正当な要求であること」を確認するための値です
- 「認可リクエストを送った本人（ブラウザ）」と「認可コードを受け取って戻ってきた本人」が同一であることを確認します

### 背景
OAuthでは、

- ブラウザリダイレクトを利用する
- 外部の認可サーバを経由する

という特性上、第三者が用意した認可応答を被害者のブラウザに送りつけるCSRF攻撃が成立します。


```mermaid
sequenceDiagram
    autonumber
    participant User as ユーザー (Browser)
    participant Client as サービス(Client)
    participant AuthServer as 認可サーバー
    participant Attacker as 攻撃者

    Note over Client: 1. 一時的なランダム値(state)を生成<br/>2. Cookie(Session)に保存

    User->>Client: ログイン開始
    Client->>User: 認可URLへリダイレクト<br/>(state=ABC を付与)
    
    Note over Attacker, User: --- CSRF攻撃の試み ---
    Attacker->>User: 攻撃者の準備した認可URLを踏ませる<br/>(state=XYZ ※攻撃者が用意した値)

    User->>AuthServer: 認可リクエスト (state=ABC)
    AuthServer->>User: 認証・同意
    
    AuthServer-->>User: 認可コード + state=ABC を返却
    User->>Client: 認可コード + state=ABC を持って戻る

    Note over Client: 3. 受信した state(ABC) と<br/>Cookie内の state(ABC) を照合

    alt stateが一致
        Client->>AuthServer: トークンリクエスト
        AuthServer->>Client: アクセストークン発行
        Client-->>User: ログイン成功
    else stateが不一致（攻撃の可能性）
        Client-->>User: エラー (403 Forbidden)
    end
```

**説明**
- クライアント側での準備: 認可リクエストを送る直前に、サーバー（またはブラウザのセッション）側でランダムな文字列 state を生成し、Cookieに紐付けて保存しておきます。
- 認可サーバーの役割: 認可サーバーは、リクエストに含まれていた state を、認可コードと一緒にそのままクライアントへ送り返します。
- 突合チェック: クライアントは、戻ってきた state と、自分が保存しておいた state を比較します。
- 攻撃の遮断: もし攻撃者が自分の state を使ってユーザーに不正な認可フローを踏ませようとしても、ユーザーのCookieに保存されている state とは一致しないため、クライアント側で処理を中断できます。

:::message
stateは推測が不可能なランダムな値である必要があります。
:::

### PKCEとの比較
- 原則的に両方併用が前提です
- PKCEは「認可コードの横取り」を防ぎ、state は「リクエストの偽造（CSRF）」を防ぐという異なる役割を持っています

| 項目   | state      | PKCE                 |
| ---- | ---------- | -------------------- |
| 防ぐ攻撃 | CSRF       | 認可コード横取り             |
| 検証主体 | Client     | Authorization Server |
| 目的   | セッション正当性確認 | コード使用者の正当性確認         |
