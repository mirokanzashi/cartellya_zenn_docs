---
title: "SAML認証とOIDC"
emoji: "✅"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["学習記録"]
published: true
---

# SAML認証（Security Assertion Markup Language 認証）

- 異なるシステム・組織間で、認証結果を安全に連携するためのフェデレーション認証方式です。
- シングルサインオンの一種です
- 認証そのものを委譲し、認証結果だけを連携するための**XMLベース**の標準仕様です。

## 仕組み
1. 利用者がSPにアクセス
2. SPがIdPへ認証を委譲
3. IdPが利用者を認証
4. IdPが SAML Assertion（認証結果） を発行
5. SPがAssertionを検証
6. SPでセッション確立


| 用語 | 正式名称 | 役割 |
| --- | -------- | ---- |
| IdP | Identity Provider | 認証を行い、認証結果を発行する |
| SP | Service Provider | 認証結果を信頼してサービスを提供する |
| アサーション | Assertion | IdPが発行する「認証済みであることの証明書」 |

:::message
アサーションに含まれる主な情報：利用者識別子、認証時刻、有効期限、属性情報（任意）、電子署名（改ざん防止）
:::

```mermaid
sequenceDiagram
    autonumber
    participant B as ブラウザ
    participant SP as サービス(SP)
    participant IdP as 認証基盤(IdP)

    Note over B, SP: 【1. アクセス開始】
    B->>SP: サービスを利用したい
    
    Note over SP, B: 【2. IdPへの転送依頼】
    SP-->>B: HTTP 302 Redirect<br/>(SAML認証リクエストを付与)
    Note left of B: 「これをIdPに届けて！」と依頼される

    Note over B, IdP: 【3. 依頼書の提出】
    B->>IdP: SAML認証リクエストを送信
    
    Note right of IdP: ユーザーを認証

    Note over IdP, B: 【4. 署名付きチケットの受託】
    IdP-->>B: HTTP POST Form (SAMLレスポンス)<br/>(デジタル署名付き)
    Note left of B: 「これをSPに投げ返して！」と託される

    Note over B, SP: 【5. チケットの提出】
    B->>SP: SAMLレスポンスをPOST送信
    
    Note left of SP: IdPの署名を検証し、<br/>ユーザーを特定
    SP-->>B: ログイン成功！(サービス画面表示)
```

# OIDC (OpenID Connect)
OAuth 2.0 に「認証機能」を追加した仕様です
## 仕組み

### ロール
End User：利用者
Client：アプリケーション
OpenID Provider（OP）：認証サーバ

### 処理の仕組み
1. 利用者がClientにアクセス
2. ClientがOPへ認証要求
3. OPが利用者を認証
4. 認可コード発行
5. Clientがコードをトークンと交換
6. IDトークン取得
7. Clientでログイン確立

```mermaid
sequenceDiagram
    autonumber
    actor User as エンドユーザー<br/> (Browser)
    participant RP as Client<br/> (アプリ)
    participant OP_Auth as 認可サーバー<br/> (認証サーバー/ OP)
    participant OP_Token as 認可サーバー<br/> (トークン/UserInfo)

    Note over User, OP_Token: 【1. 認可リクエスト】
    User->>RP: ログインボタンをクリック
    RP->>User: 認可エンドポイントへリダイレクト<br/>(scope=openid, response_type=code, client_id, etc.)
    User->>OP_Auth: 認証リクエスト

    Note over User, OP_Token: 【2. ユーザー認証 & 認可】
    OP_Auth->>User: ログイン画面表示
    User->>OP_Auth: ID/パスワード入力・ログイン
    OP_Auth->>User: 同意画面表示（プロフィールの提供など）
    User->>OP_Auth: 同意（認可）

    Note over User, OP_Token: 【3. 認可コードの発行】
    OP_Auth->>User: Redirect URI へリダイレクト<br/>(code=認可コード)
    User->>RP: 認可コードを渡す

    Note over User, OP_Token: 【4. トークンリクエスト】
    RP->>OP_Token: トークンエンドポイントへリクエスト<br/>(code, client_secret)
    OP_Token->>RP: IDトークン & アクセストークンを返却

    Note over User, OP_Token: 【5. ユーザー情報の取得（任意）】
    RP->>OP_Token: UserInfoエンドポイントへリクエスト<br/>(Access Token)
    OP_Token->>RP: ユーザープロフィール情報を返却
    RP->>User: ログイン完了・マイページ表示
```

## トークン
### 主なトークン
| トークン       | 役割         |
| ---------- | ---------- |
| IDトークン     | 認証結果（本人確認） |
| アクセストークン   | APIアクセス    |
| リフレッシュトークン | 再取得用       |

### IDトークン
- JWT形式
- 含まれる情報：利用者識別子（sub）、認証時刻（auth_time）、発行者（iss）、対象クライアント（aud）、有効期限（exp）
- 署名付き（改ざん防止） 