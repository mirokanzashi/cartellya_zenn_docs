---
title: "初心者のMCPお試しノート #3 – MCPの仕組み"
emoji: "✅"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["MCP"]
published: true
---

# MCP（Model Context Protocol）とは
MCPは、AIモデル（LLM）と外部ツール・データ・サービスを安全かつ統一的な方法で接続するためのプロトコルです。

現在、LLMは急速に進化し、自然言語での指示が実用的なレベルに到達しました。
今後も多くのAI関連サービスが開発・普及することが予想される一方で、
サービス間の連携や統合は難しく、開発者の負担になりやすいという課題があります。

この課題を解決するために登場したのが MCP です。

# MCPの仕組み

```
[MCPホスト層]　Claude Desktop、VS code、その他のMCP対応アプリ
        │
        ▼
[MCPクライアント層]　JSON-RPC、サーバーマネージャー、セキュリティーレイアーなど
        │
        ▼
[MCPサーバー]　外部ツール・API・DB・アプリ

```

### MCPホスト
ユーザーにとっての操作画面となるレイヤーです。
- UI（ユーザーインターフェース）の提供
- ユーザーとの対話の管理
- MCPサーバーのライフサイクル管理
- セキュリティポリシーの適用

### MCPクライアント
LLMとMCPサーバーの接続部分を担います。
ユーザーの意図を理解し、適切なツールの選択・実行を行います。

主な役割：
- 自然言語理解・推論
- コンテキスト管理
- ツール選択の最適化
- エラーハンドリング

提供機能：
| 機能          | 内容                          |
| ----------- | --------------------------- |
| Sampling    | サーバー側が生成依頼 → クライアントがモデル呼び出し |
| Elicitation | 追加情報が必要な場合、ユーザーへ問い合わせ       |


:::message
※現在のMCP対応ホストは AI 機能を内包していることが多く、
ホストとクライアントが一体化しているケースが主流です
（例：VS Code, Cursor, Claude for Desktop, Cline など）
:::

### MCPサーバー
外部サービスやツールの実処理を担当します。
サーバーはステートレス（状態を持たない）で、純粋に機能を提供します。

提供機能：

| 種類        | 内容                            |
| --------- | ----------------------------- |
| Tools     | 外部処理関数・ツールの実行                 |
| Resources | ファイルやDBなどのリソース公開（計算ロジックは持たない） |
| Prompts   | 事前定義されたテンプレートプロンプト            |


### Roots（ルート）
MCP全体の安全性・依存関係・進行を制御するレイヤーです。
- AIのアクセス可能範囲の制御
- 担当エージェントの割り当て
- タスクの依存関係管理
- 進捗状況・失敗ログの保持
- 緊急度・優先度の判断
- 状況に応じたタスクの再割り当て


## MCPの処理フロー

```
[MCPホスト]　ユーザー入力
       │
       ▼
[MCPクライアント / LLM]　理解・推論・タスク設計
       │ 抽象命令
       ▼
[MCPサーバー]　標準化された安全なAPI呼び出し
       │
       ▼
[外部ツール / サービス] Slack / Teams / X / DB など


```

例：ユーザーが「発表会の告知を準備して」と依頼した場合

1. ユーザーが指示を送信
2. LLMが内容を理解しタスクを分解
3. 必要なツール・APIを判断し、実行指示を出す
4. MCPサーバーが抽象命令を実ツールAPIへ橋渡し
5. Slack、Teams、X などに告知文を投稿
6. 結果を収集しユーザーへ報告


## MCPのライフサイクル

```
┌───────────────────┐
│ ① 接続 (認証)      │
└───────────────────┘
            ▼
┌─────────────────────────┐
│ ② 能力宣言の取得         │
│   (どんなツールを使えるか)│
└─────────────────────────┘
            ▼
┌───────────────────────┐
│ ③ ツール実行           │
│   (呼び出し・結果返却) │
└───────────────────────┘
            ▼
┌──────────────────────┐
│ ④ ストリーミング・連続 │
│   (状態保持・再実行)   │
└──────────────────────┘
            ▼
┌─────────────────────┐
│ ⑤ 切断・クリーンアップ│
└─────────────────────┘
```

**1. 接続（Connect）**
  - MCPサーバーへの接続
  - 認証、権限、バージョン互換性チェック

**2. サービス宣言の読み込み（Registry / Capabilities）**
  - MCPサーバーが提供可能なツールやリソースを公開
  - LLMはこの段階で初めて「利用できる機能」を知る


**3. ツール実行（Invoke + Context Management）**
  - ユーザー要求に応じて必要なツールを実行
  - API仕様の違いはMCPが吸収し標準化された形式で実行
  - 失敗時は例外情報をLLMに返却

**4. ストリーミング実行・連続タスク（Session / Streaming）**
  - 単発処理だけでなく、セッションを通じた状態保持が可能
  - 長時間処理・対話的処理に対応

**5. 切断・クリーンアップ（Disconnect）**
  - セッション終了
  - キャッシュ・認証データの破棄
  - ファイルハンドル・接続のクローズ
  - エージェント側の状態更新