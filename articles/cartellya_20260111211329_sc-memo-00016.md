---
title: "DNSサーバセキュリティ"
emoji: "✅"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["学習記録"]
published: true
---

# DNSサーバ（Domain Name System Server）
名前解決（名前 → IPアドレス）を行い、クライアントが通信先を特定できるようにするサーバです

## DNSサーバの種類
### フルサービスリゾルバ（キャッシュDNS、再帰DNS）
- 利用者端末の代わりに名前解決を実行します
- 問い合わせ結果をキャッシュします
### 権威DNSサーバ（Authoritative DNS）
- 最終的な正解を保持します
- ゾーン情報を管理します

### 名前解決の流れ
1. クライアント → キャッシュDNS（キャッシュされない場合）
2. キャッシュDNS → 上位DNS → 更に上位のDNS → ... → 権威DNS
3. 権威DNS → IPアドレス回答

:::message
キャッシュDNSが情報を持っている場合はそのままクライアントに回答します
:::

### DNSで扱う主なレコード
| レコード  | 内容       |
| ----- | -------- |
| A     | IPv4アドレス |
| AAAA  | IPv6アドレス |
| CNAME | 別名       |
| MX    | メールサーバ   |
| NS    | 権威DNS    |
| TXT   | 認証・ポリシー  |

# DNSサーバセキュリティ

## DNSキャッシュポイズニング（キャッシュ汚染）
DNSリゾルバ（キャッシュDNS）に偽の名前解決情報を記憶させる攻撃です

### 攻撃仕組み
1. キャッシュDNSが正規の権威DNSに問い合わせ
2. 攻撃者が偽の応答を**先に**送り付ける
3. キャッシュDNSが偽情報を保存
4. 利用者が偽サイトへ誘導

### オフパス攻撃
- 攻撃者は通信経路上にいない
- 推測で偽のDNS応答を大量送信

**手口**
1. 攻撃者が被害DNSに問い合わせを発生させる（例：存在しないサブドメイン）
2. キャッシュDNSが権威DNSに問い合わせ開始
3. 攻撃者が以下を推測して偽応答を送信（トランザクションID（16bit）、送信元ポート）
4. 正解が先に届けばキャッシュ成功

:::message
DNSでは、最初に一致した応答を正解として、後続の応答は破棄します
→ 「先着順」が攻撃の成立条件
:::

### オンパス攻撃
- 攻撃者が通信経路上に存在
- 応答内容を確実に改ざん

**手口**
- ARPスプーフィング
- Wi-Fiなりすまし

## Kaminsky攻撃
DNSキャッシュポイズニングを高速かつ高確率で成功させるためのオフパス攻撃手法です

**仕組み**
1. 攻撃者がキャッシュDNSに問い合わせを大量発生（存在しないサブドメイン）
2. キャッシュDNSが権威DNSへ問い合わせ
3. 攻撃者が偽のDNS応答を大量送信
    - 推測対象：トランザクションID、送信元ポート
    - 応答内容：偽IP、NSレコード書き換え
4. 正解が先に届くとキャッシュ成功

**対策**
- DNSSEC
- 送信元ポートランダム化
- トランザクションID強化
- 不要なNSキャッシュ抑制

## ARPスプーフィング（ARPポイズニング）
偽のARP応答を送信して、IPアドレスとMACアドレスの対応関係を誤認させる攻撃です

**仕組み**
1. 攻撃者が偽のARP応答を送信
2. 被害端末・ルータがARPテーブルを書き換え
3. 通信が攻撃者経由になる

**対策**
- Dynamic ARP Inspection (DAI)
- 静的ARP設定
- 暗号化通信（TLS）


## DNSなりすまし（DNS Spoofing）
DNS問い合わせに対して偽の応答を返すことで、通信先を偽装する攻撃です

**攻撃の流れ**

1. 利用者が名前解決要求
2. 攻撃者が正規DNSを装って応答
3. 利用者が偽IPへ接続

**対策**
- DNSSEC
- DoT/DoH（盗聴・改ざん防止）

:::message
DoT: DNS over TLS
DoH: DNS over HTTPS
:::

## DNSリフレクション／アンプ攻撃（DDoS）
- 送信元IPを詐称したDNS問い合わせで大容量応答を被害者に集中させるDDoS攻撃です
- リフレクション（Reflection）：応答を第三者（被害者）に反射させることです
- アンプ（Amplification）：少量の問い合わせで大容量の応答を発生させ、通信量を増幅させることです

**仕組み**
1. 攻撃者が送信元IPアドレスを被害者に偽装して、再帰問い合わせをDNSサーバに送信
2. DNSサーバは被害者に対して大容量の応答を返す
3. 少量の問い合わせで大量トラフィックを発生させられる（増幅）
4. 再帰問い合わせは応答サイズが大きくなりやすく、増幅率が高い

**対策**
- 再帰問い合わせの制御
- レートリミットの設定：同一送信元からの問い合わせ数を制限
- DNSSECの導入


# セキュリティ共通対策
## 権威DNSサーバに不要な記載を残さない
CDNサービスやクラウドサービスの利用を停止した場合に、CNAMEレコードやAレコードを削除します

## オープンリゾルバの制御
- オープンリゾルバとは、インターネットからの再帰問い合わせに対して応答するキャッシュDNSサーバのことです
- 原則的に、外部からの問い合わせは回答しないが、内部の問い合わせに対して回答しても問題ないです

**比較**
| 項目      | 再帰問い合わせ       | 非再帰問い合わせ          |
| ------- | ------------- | ----------------- |
| 問い合わせ主体 | クライアント        | クライアント            |
| 探索の実行   | DNSサーバが代行 | クライアントが段階的に実施 |
| 応答内容    | 最終結果          | 照会先のヒント（例：次の問い合わせサーバのIP）    |
| 主な利用者   | 端末・アプリ        | DNSサーバ            |

**実施内容**
- 権威DNSサーバとキャッシュDNSサーバを別のサーバに分ける（２台）
- 権威DNSサーバは外部からの問い合わせを回答しないといけないため、キャッシュ機能を持たないようにします
- キャッシュサーバには、コンテンツ機能を持たないようにします
- キャッシュサーバに適切なアクセスコントロールを施して、外部からのアクセスを禁止します
- 典型的な悪用例：DDoS攻撃の踏み台になります

:::message
コンテンツ機能：DNSサーバ自身が管理しているゾーン情報（資源レコード）を保持し、それに基づいて応答する機能です
:::

## ソースポートランダマイゼーション（Source Port Randomization）
攻撃者は、偽応答が正規として受理されるため、応答に含まれる「トランザクションID」と「送信元ポート番号」が一致する必要があります
送信元ポート番号をランダム化することで、攻撃者が一致させるべき値が増え、偽応答の成功確率が著しく低下する
DNSキャッシュポイズニング攻撃に対して効果があります

## DNSSEC（Domain Name System Security Extensions）
電子署名と信頼の連鎖によりDNS応答の真正性と完全性を検証する仕組みです

**特徴**
- DNS応答が改ざんされていません（完全性）
- 正当な権威DNSサーバからの応答です（真正性）
- 機密性（暗号化）は提供しません
- 導入は「権威DNS＋キャッシュDNS」の双方が前提です

**仕組み**
- 電子署名による検証
  - 権威DNSサーバは、DNSレコードに電子署名を付与
  - 再帰DNSサーバは公開鍵で署名を検証
- 公開鍵の正当性確認（信頼の連鎖）
  - 公開鍵はDNSKEYレコードとして公開
  - 上位ゾーンからのDSレコードにより正当性を保証
  - ルートDNSから末端ドメインまで「信頼の連鎖」を形成
- 再帰DNSサーバ側での検証
  - 利用者ではなく、再帰DNSサーバが検証を行う
  - 検証に失敗した応答は破棄される

**防げる攻撃**
- DNSキャッシュポイズニング
- 偽DNS応答によるフィッシング誘導