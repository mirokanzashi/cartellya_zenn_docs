---
title: "PKI"
emoji: "✅"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["学習記録"]
published: true
---

# デジタル証明書
- 公開鍵が「誰のものか」を証明するためのデータです
- 異なる環境や異なるアプリケーションを問題なく利用できるように、X.509で標準化されています

### 証明書に記載する重要な項目
- シリアル番号：CAが付与するユニークな番号
- 署名アルゴリズム：CAが証明書に署名する時に利用したアルゴリズム
- 発行者：認証局の名称
- 有効期限：有効期限の開始日と有効期限の終了日
- サブジェクト：名称
- 公開鍵アルゴリズム
- 公開鍵

# 公開鍵基盤（Public Key Infrastructure, PKI）
- 公開鍵とその所有者の対応関係を証明し、信頼を管理するための仕組みです
    - 公開鍵暗号では、「この公開鍵は本当に相手のものか」という問題を解決するため、信頼できる第三者が保証する仕組みです

## 運用環境

| 区分      | 主な役割       | 具体的な処理内容 |
| --------- | ----------------- | ------------- |
| CA        | 認証局（総称）   | PKI全体の信頼基点<br/>  証明書発行・失効管理         |
| IA        | 発行局   | 電子証明書の実発行・署名<br/>CSR処理、署名、番号管理    |
| RA        | 登録局   | 利用者の本人確認  |
| VA        | 検証局   | 証明書の有効性確認<br/>OCSP応答、CRL参照          |
| AA        | 属性局   | 属性証明書の発行<br/>役割・資格・権限の証明            |


### 認証局(Certification Authority, CA)
- 証明書の登録から発行まで一連の業務を行います
- RAとIAの機能を包含する役割として説明されることが多いです
- CA= RA + IA

### 登録局(Registration Authority, RA)
- 証明書の申請
- 証明書の承認
- 証明書の失効
- 利用者の本人確認

### 発行局(Issuing Authority, IA)
- 証明書のDB管理
- 証明書の発行・署名
- CRLの発行
- 証明書署名要求（CSR）の処理
- シリアル番号管理
- 有効期限設定

### 検証局(Validation Authority, VA) 
- 証明書の有効性や失効状態を検証します
- 証明書は発行しない
- 検証専用
- CAの負荷軽減。小規模のPKIではRAが兼任する場合があります

### 属性局(Attribute Authority, AA) 
- 利用者の属性情報を証明し、認可に利用する機関です
- 属性とは
    - 所属部署
    - 役職
    - 権限
    - 資格
    - ロール
- 認可判断に利用します(認証（本人確認）ではなく 認可向け)
- 公開鍵は含まない
- AAがない場合は、その役割はIAが担います

### Certificate Signing Request, CSR
デジタル証明書を申請・取得するためにCAへ提出する証明書署名要求のことです

### Certificate Revocation List, CRL
- **有効期限切れ以外**の理由で失効された証明書の一覧表
- 例えば、秘密鍵の漏えいで失効を申請します

## PKIの仕組み
1. 利用者が鍵ペア生成します
2. 公開鍵を含めて、CP/CPSに記載したルールに従って、CA/RAに証明書申請（CSR）します
3. RAが本人確認
4. CAが証明書発行・署名
5. 利用者が証明書を利用
6. 相手がCA署名を検証



### Certificate Policy,CP / Certification Practice Statement, CPS
- CP：証明書ポリシー
- CPS：認証局運用規定
- 認証局では、CPとCPSを作成して管理し、必要に応じて利用者に公開します

# デジタル証明書の検証
### デジタル署名の検証
1. メッセージダイジェスト（MD）作成：送信側は、送信したい文書（平文）からハッシュ関数を使って、固定長のハッシュ値を作成します　→　平文
2. デジタル署名作成：メッセージダイジェストを秘密鍵を使って署名します　→　平文+デジタル署名(MD含む)
3. 送信メッセージに、デジタル証明書を添付します　→　平文+デジタル署名(MD含む)+デジタル証明書
4. 相手に送信します
5. デジタル証明書とCAの突合せ：受信側は、CAの公開鍵を使って検証し、CAの正当性を確認します　→　平文+デジタル署名(MD含む)+デジタル証明書[検証済み]
6. デジタル証明書の中にある公開鍵を用いて、デジタル署名に変換処理を行います。改ざんや他人になりすましされていない場合、送信側が署名前のMDと同値になります　→　MD（デジタル署名で変換）
7. 受信側は、送信側と同じハッシュ関数を使ってMDを作成します　→　MD（平文で作成）
8. MD（デジタル署名で変換）とMD（平文で作成）を比較して、同じであれば、「他人のなりすましではない」ことと「改ざんされていない」ことが確認できます　→　平文[検証済み]+デジタル署名(MD含む)[検証済み]+デジタル証明書[検証済み]

### 有効期限の検証
デジタル証明書に記載されてる有効期限をチェックします

### 失効情報のチェック
- 有効期間の証明書だが、失効（利用できない）状況かどうかを確認します
    - 例えば、人員の異動と退職、秘密鍵の紛失、悪用の発覚など
- CRLを確認します
- OCSPで確認します

### Online Certificate Status Protocol, OCSP
- オンラインでリアルタイムに失効情報を確認する仕組みです
- 事前にOSCPレスポンダ（OCSPサーバ）を立てて、事前にCRLを取り込むが必要です
- CRLの確認と比べて、比較的にタイムラグが少ないです

### ルート認証局とルート証明書の検証
- CAさえあれば、証明書が発行できるため、そのCA信頼できるかどうか問題があります
- 作業を同じ認証局に集中すると処理しきれない問題があります

この問題を解決するため、ルートCAとデジタル証明書の階層管理がでます
- ルートCA（最上位CA）は自己署名します
- ルートCAは下位認証局を認証します
- 下位認証局は自分の下位認証局を認証します
- この仕組みは信頼の連鎖（トラストチェーン）といいます

:::message
ルートCAは事前に厳しい審査基準をクリアしたため、自己署名の証明書を信頼できます
:::

CAを検証する時に、
- CAの証明書を確認します
- CAの証明書より上位のCAを確認します
- 上位CAの証明書よりさらに上位のCAを確認します
- 最後にルートCAに到達します

:::message
ブラウザは既に数多くのルート証明書を組み込まれています
:::

**社内CAの利用**
- 社内CAを使用する時に、ルートCAに到達できないため、ブラウザに警告メッセージが出ます
  - 社内CAを認証します
  - 社内CAをルートCAとしてブラウザに登録します


:::message
自己署名証明書（Self-Signed Certificate）：第三者の認証局（CA）による検証・保証を受けずに、自分自身で発行・署名した電子証明書を指します。俗称はオレオレ証明書です
:::


:::message
ルートCAにある証明書はルート証明書といいます
:::

### 証明書のレベル
- DV(Domain Validation)：ドメインだけを確認
- OV(Organization Validation)：企業の実在性を確認
- EV(Extended Validation)：DVやOVより厳しい審査基準
- 審査基準の厳格さ：DV < OV < EV

### アクセス先のチェック
アクセス先のサーバがデジタル証明書に記載されたものと同じかどうかを確認します

1. subjectAltName(サブジェクト代替名、略称SAN)に記載されているFQDN(dNSName=FQDNとして記載)とアクセス先のFQDNを比較します
2. SANがなければ、サブジェクトのCN（commonName：コモンネーム）に設定されているFQDNとアクセス先のFQDNを比較します

:::message
FQDN(Fully Qualified Domain Name)：ホスト名からルートドメインまでを省略せずに記述したドメイン名です
構造：`ホスト名.サブドメイン.トップレベルドメイン　→　www.example.co.jp`
**ポート番号を含まない**
**プロトコル(http/httpsなど)を含まない**
:::