---
title: "JWT"
emoji: "✅"
type: "idea" # tech: 技術記事 / idea: アイデア
topics: ["学習記録"]
published: true
---

# JWT(JSON Web Token)

- 当事者間で安全に情報を伝達するための、JSON形式のトークン仕様です。
- OpenID Connectの認証トークンや OAuth 2.0のアクセストークンで広く利用されています。

### JWTの基本構造
- JWTは 3つの部分 から構成され、`.`で連結されます。
- ヘッダとペイロードはBASE64URLでエンコードします

**形式**
```
ヘッダ.ペイロード.署名
```

## JWTの三要素
### ヘッダ（Header）
- トークンのタイプと署名アルゴリズムなどのメタデータです
- typ:通常はJWTを使います

**形式**
```
{
  "alg": "RS256",
  "typ": "JWT"
}

```

| alg | 意味 |
| --- | ---- |
| HS256 | HMAC using HSA256<br/>対象型アルゴリズム<br/>双方で共有している秘密鍵（共通鍵）を使う |
| RS256 | RSASSA-PKCS1-v1_5 with SHA256 <br/>非対称型アルゴリズム。<br/>秘密鍵と公開鍵のペアを使う|
| ES256 | ECDSA with P-256 and SHA256<br/> 非対称型アルゴリズム<br/> 楕円曲線暗号を使う |
| NONE | 署名なし。セキュリティが確保されていない |


### ペイロード（Payload）
- トークンに含まれる実際のデータです
- クレーム（Claims）を格納します
- 登録済みクレーム：RFC7519で規定されているクレームです

| 登録済みクレームの例 | 意味 |
| ---- | ---- |
| iss | 発行者 |
| sub | 対象者 |
| exp | 有効期限 |
| iat | 発行時間 |

| カスタムクレームの例 | 意味 |
| ---- | ---- |
| user | 利用者 |
| name | ユーザ名 |
| role | 役割 |

### 署名（Signature）
- ヘッダとペイロードを署名します
- 改ざん検知と真正性保証ができます

## JWTの種類
### JWS (JSON Web Signature)
- 軽量
- 暗号化されていないため、ペイロードに秘密情報を含めることを避けたいです
- 暗号化が必要な場合、JWEを使うか、HTTPSと併用するかを検討します

### JWE (JSON Web Encryption)
- ペイロードを暗号化できます
- JWSより処理が重くなり、システムのパフォーマンスに影響を与える可能性があります

# JWTのセキュリティ
## サーバー側の問題
- algをNONEに設定できます
- 攻撃者が自分に都合のいいトークンを自由に作成できて、不正アクセスされるリスクがあります

**対策**
- JWTを扱うサーバーやライブラリでは、NONEアルゴリズムを無効にするか、拒否するように構成します
- 許可する署名アルゴリズムは強力なものに制限します
- トークンが改ざんされていないことを確認するため、署名を必ず検証します

## クライアント側の問題
- JWTをクライアントで保存する際、ローカルストレージやcookieに保存することが一般的です
- XSSやCSRF攻撃によってトークンが窃取されるリスクがあります

**対策**
- ローカルストレージに保存することを避けます
- Javascriptからのアクセスを防ぐため、CookieのHttpOnly属性を設定します
- CSRFの攻撃を防ぐため、SameSite属性をstrictまたはlaxに設定します
- XSSの対策として、適切なサニタイズ処理を行い、外部からのスクリプトが注入されないようにします

## 通信時のリスク
- 盗聴または中間者攻撃（MTTM）を受けるリスクがあります

**対策**
- トークンを送信する際に、HTTPSを使用して、通信を暗号化します
- cookieに保存する場合に、Secure属性を設定して、cookieもHTTPS経由でのみ送信します
- 必要であれば、JWEの利用を検討します

## リプレイ攻撃
攻撃者が有効な情報やトークンを六角、それを再利用することで、正規ユーザになりすまし手法です

**対策**
- JWTの有効期限を短く設定します。（攻撃者がトークンを割いるようできる時間を制限します）
- jtiクレームを利用し、トークンに一意の識別子を割り当てます。
    - サーバ側でこの識別子を使ってトークンの使用履歴を管理し、同じトークンが再利用されないようにすることで、リプレイ攻撃を防げます
- リクエスト毎でナンス(Nonce)をカスタムクレームとして利用します
    - サーバ側は各リクエストでナンスをチェックし、同じナンスが二度使用されないことを確認します
    - サーバ側でのナンスの保持や管理の仕組みが重要です

:::message
**jti**：JWT IDの略称です。登録済みクレームの一つです
:::

:::message
**ナンス**：一度しか使われない値（Number used once）であり、通信や認証の各処理で一回限り使用されるランダム値です
:::